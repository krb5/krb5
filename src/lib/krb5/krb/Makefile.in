CFLAGS = $(CCOPTS) $(DEFS)
RUN_SETUP = @KRB5_RUN_ENV@
PROG_LIBPATH=-L$(TOPLIBD)
PROG_RPATH=$(KRB5_LIBDIR)

##DOSBUILDTOP = ..\..\..
##DOSMYNAME=krb
##DOSOBJFILE=..\$(MYNAME).lst
##WIN16##LIBNAME=..\krb5.lib

STLIBOBJS= \
	addr_comp.o	\
	addr_order.o	\
	addr_srch.o	\
	auth_con.o	\
	bld_pr_ext.o	\
	bld_princ.o	\
	chk_trans.o	\
	conv_princ.o	\
	copy_addrs.o	\
	copy_auth.o	\
	copy_athctr.o	\
	copy_cksum.o    \
	copy_creds.o	\
	copy_data.o	\
	copy_key.o	\
	copy_princ.o	\
	copy_tick.o	\
	cp_key_cnt.o	\
	crypto_glue.o	\
	decode_kdc.o	\
	decrypt_tk.o	\
	encode_kdc.o	\
	encrypt_tk.o	\
	free_rtree.o	\
	fwd_tgt.o	\
	gc_frm_kdc.o	\
	gc_via_tkt.o	\
	gen_seqnum.o	\
	gen_subkey.o	\
	get_creds.o	\
	get_in_tkt.o	\
	in_tkt_ktb.o	\
	in_tkt_pwd.o	\
	in_tkt_sky.o	\
	init_ctx.o	\
	kdc_rep_dc.o	\
	mk_cred.o	\
	mk_error.o	\
	mk_priv.o	\
	mk_rep.o	\
	mk_req.o	\
	mk_req_ext.o	\
	mk_safe.o	\
	parse.o		\
	pr_to_salt.o	\
	preauth.o	\
	princ_comp.o	\
	rd_cred.o	\
	rd_error.o	\
	rd_priv.o	\
	rd_rep.o	\
	rd_req.o	\
	rd_req_dec.o	\
	rd_safe.o	\
	recvauth.o	\
	sendauth.o	\
	send_tgs.o	\
	ser_actx.o	\
	ser_adata.o	\
	ser_addr.o	\
	ser_auth.o	\
	ser_cksum.o	\
	ser_ctx.o	\
	ser_eblk.o	\
	ser_key.o	\
	ser_princ.o	\
	serialize.o	\
	srv_rcache.o	\
	str_conv.o	\
	tgtname.o	\
	unparse.o	\
	valid_times.o	\
	walk_rtree.o

OBJS=	addr_comp.$(OBJEXT)	\
	addr_order.$(OBJEXT)	\
	addr_srch.$(OBJEXT)	\
	auth_con.$(OBJEXT)	\
	bld_pr_ext.$(OBJEXT)	\
	bld_princ.$(OBJEXT)	\
	chk_trans.$(OBJEXT)	\
	conv_princ.$(OBJEXT)	\
	copy_addrs.$(OBJEXT)	\
	copy_auth.$(OBJEXT)	\
	copy_athctr.$(OBJEXT)	\
	copy_cksum.$(OBJEXT)    \
	copy_creds.$(OBJEXT)	\
	copy_data.$(OBJEXT)	\
	copy_key.$(OBJEXT)	\
	copy_princ.$(OBJEXT)	\
	copy_tick.$(OBJEXT)	\
	cp_key_cnt.$(OBJEXT)	\
	crypto_glue.$(OBJEXT)	\
	decode_kdc.$(OBJEXT)	\
	decrypt_tk.$(OBJEXT)	\
	encode_kdc.$(OBJEXT)	\
	encrypt_tk.$(OBJEXT)	\
	free_rtree.$(OBJEXT)	\
	fwd_tgt.$(OBJEXT)	\
	gc_frm_kdc.$(OBJEXT)	\
	gc_via_tkt.$(OBJEXT)	\
	gen_seqnum.$(OBJEXT)	\
	gen_subkey.$(OBJEXT)	\
	get_creds.$(OBJEXT)	\
	get_in_tkt.$(OBJEXT)	\
	in_tkt_ktb.$(OBJEXT)	\
	in_tkt_pwd.$(OBJEXT)	\
	in_tkt_sky.$(OBJEXT)	\
	init_ctx.$(OBJEXT)	\
	kdc_rep_dc.$(OBJEXT)	\
	mk_cred.$(OBJEXT)	\
	mk_error.$(OBJEXT)	\
	mk_priv.$(OBJEXT)	\
	mk_rep.$(OBJEXT)	\
	mk_req.$(OBJEXT)	\
	mk_req_ext.$(OBJEXT)	\
	mk_safe.$(OBJEXT)	\
	parse.$(OBJEXT)		\
	pr_to_salt.$(OBJEXT)	\
	preauth.$(OBJEXT)	\
	princ_comp.$(OBJEXT)	\
	rd_cred.$(OBJEXT)	\
	rd_error.$(OBJEXT)	\
	rd_priv.$(OBJEXT)	\
	rd_rep.$(OBJEXT)	\
	rd_req.$(OBJEXT)	\
	rd_req_dec.$(OBJEXT)	\
	rd_safe.$(OBJEXT)	\
	recvauth.$(OBJEXT)	\
	sendauth.$(OBJEXT)	\
	send_tgs.$(OBJEXT)	\
	ser_actx.$(OBJEXT)	\
	ser_adata.$(OBJEXT)	\
	ser_addr.$(OBJEXT)	\
	ser_auth.$(OBJEXT)	\
	ser_cksum.$(OBJEXT)	\
	ser_ctx.$(OBJEXT)	\
	ser_eblk.$(OBJEXT)	\
	ser_key.$(OBJEXT)	\
	ser_princ.$(OBJEXT)	\
	serialize.$(OBJEXT)	\
	srv_rcache.$(OBJEXT)	\
	str_conv.$(OBJEXT)	\
	tgtname.$(OBJEXT)	\
	unparse.$(OBJEXT)	\
	valid_times.$(OBJEXT)	\
	walk_rtree.$(OBJEXT)

SRCS=	$(srcdir)/addr_comp.c	\
	$(srcdir)/addr_order.c	\
	$(srcdir)/addr_srch.c	\
	$(srcdir)/auth_con.c	\
	$(srcdir)/bld_pr_ext.c	\
	$(srcdir)/bld_princ.c	\
	$(srcdir)/brand.c	\
	$(srcdir)/chk_trans.c	\
	$(srcdir)/conv_princ.c	\
	$(srcdir)/copy_addrs.c	\
	$(srcdir)/copy_auth.c	\
	$(srcdir)/copy_athctr.c	\
	$(srcdir)/copy_cksum.c   \
	$(srcdir)/copy_creds.c	\
	$(srcdir)/copy_data.c	\
	$(srcdir)/copy_key.c	\
	$(srcdir)/copy_princ.c	\
	$(srcdir)/copy_tick.c	\
	$(srcdir)/cp_key_cnt.c	\
	$(srcdir)/crypto_glue.c	\
	$(srcdir)/decode_kdc.c	\
	$(srcdir)/decrypt_tk.c	\
	$(srcdir)/encode_kdc.c	\
	$(srcdir)/encrypt_tk.c	\
	$(srcdir)/free_rtree.c	\
	$(srcdir)/fwd_tgt.c	\
	$(srcdir)/gc_frm_kdc.c	\
	$(srcdir)/gc_via_tkt.c	\
	$(srcdir)/gen_seqnum.c	\
	$(srcdir)/gen_subkey.c	\
	$(srcdir)/get_creds.c	\
	$(srcdir)/get_in_tkt.c	\
	$(srcdir)/in_tkt_ktb.c	\
	$(srcdir)/in_tkt_pwd.c	\
	$(srcdir)/in_tkt_sky.c	\
	$(srcdir)/init_ctx.c	\
	$(srcdir)/kdc_rep_dc.c	\
	$(srcdir)/mk_cred.c	\
	$(srcdir)/mk_error.c	\
	$(srcdir)/mk_priv.c	\
	$(srcdir)/mk_rep.c	\
	$(srcdir)/mk_req.c	\
	$(srcdir)/mk_req_ext.c	\
	$(srcdir)/mk_safe.c	\
	$(srcdir)/parse.c	\
	$(srcdir)/pr_to_salt.c	\
	$(srcdir)/preauth.c	\
	$(srcdir)/princ_comp.c	\
	$(srcdir)/rd_cred.c	\
	$(srcdir)/rd_error.c	\
	$(srcdir)/rd_priv.c	\
	$(srcdir)/rd_rep.c	\
	$(srcdir)/rd_req.c	\
	$(srcdir)/rd_req_dec.c	\
	$(srcdir)/rd_safe.c	\
	$(srcdir)/recvauth.c	\
	$(srcdir)/sendauth.c	\
	$(srcdir)/send_tgs.c	\
	$(srcdir)/ser_actx.c	\
	$(srcdir)/ser_adata.c	\
	$(srcdir)/ser_addr.c	\
	$(srcdir)/ser_auth.c	\
	$(srcdir)/ser_cksum.c	\
	$(srcdir)/ser_ctx.c	\
	$(srcdir)/ser_eblk.c	\
	$(srcdir)/ser_key.c	\
	$(srcdir)/ser_princ.c	\
	$(srcdir)/serialize.c	\
	$(srcdir)/srv_rcache.c	\
	$(srcdir)/str_conv.c	\
	$(srcdir)/tgtname.c	\
	$(srcdir)/unparse.c	\
	$(srcdir)/valid_times.c	\
	$(srcdir)/walk_rtree.c

all-windows:: $(OBJFILE)

##DOS$(OBJFILE): $(OBJS)
##DOS	$(RM) $(OBJFILE)
##WIN16##	$(CP) nul: $(OBJFILE)
##WIN32##	$(LIBECHO) -p $(MYNAME)\ *.obj > $(OBJFILE)

all-unix:: all-libobjs

COMERRLIB=$(TOPLIBD)/libcom_err.a

T_WALK_RTREE_OBJS= t_walk_rtree.o walk_rtree.o tgtname.o unparse.o \
	free_rtree.o bld_pr_ext.o 

T_KERB_OBJS= t_kerb.o conv_princ.o unparse.o 

T_SER_OBJS= t_ser.o ser_actx.o ser_adata.o ser_addr.o ser_auth.o ser_cksum.o \
	ser_ctx.o ser_eblk.o ser_key.o ser_princ.o serialize.o 

t_walk_rtree: $(T_WALK_RTREE_OBJS) $(KDB5_DEPLIBS) $(KRB5_BASE_DEPLIBS)
	$(CC_LINK) -o t_walk_rtree $(T_WALK_RTREE_OBJS) \
		$(KDB5_LIBS) $(KRB5_BASE_LIBS)

t_kerb: $(T_KERB_OBJS) $(KDB5_DEPLIBS) $(KRB5_BASE_DEPLIBS)
	$(CC_LINK) -o t_kerb $(T_KERB_OBJS) \
		$(KDB5_LIBS) $(KRB5_BASE_LIBS)

t_ser: $(T_SER_OBJS) $(KDB5_DEPLIBS) $(KRB5_BASE_DEPLIBS)
	$(CC_LINK) -o t_ser $(T_SER_OBJS) \
		$(KDB5_LIBS) $(KRB5_BASE_LIBS)

TEST_PROGS= t_walk_rtree t_kerb t_ser

check-unix:: $(TEST_PROGS)
	KRB5_CONFIG=$(srcdir)/t_krb5.conf ; export KRB5_CONFIG ;\
	$(RUN_SETUP) ./t_kerb \
		parse_name tytso \
		parse_name tytso@SHAZAAM \
		parse_name tytso/root@VEGGIE.COM \
		parse_name tytso/tuber/carrot@VEGGIE.COM \
		parse_name tytso/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q/r/s/t \
		parse_name tytso/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q/r/s/t@FOO \
		parse_name tytso\\\\0/\\0@B\\n\\t\\\\GAG \
		parse_name tytso/\\n/\\b\\t@B\\0hacky-test \
		parse_name \\/slash/\\@atsign/octa\\/thorpe@\\/slash\\@at\\/sign \
		425_conv_principal rcmd e40-po ATHENA.MIT.EDU \
		425_conv_principal rcmd mit ATHENA.MIT.EDU \
		425_conv_principal rcmd lithium ATHENA.MIT.EDU \
		425_conv_principal rcmd tweedledumb CYGNUS.COM \
		425_conv_principal rcmd uunet UU.NET \
		425_conv_principal zephyr zephyr ATHENA.MIT.EDU \
		425_conv_principal kadmin ATHENA.MIT.EDU ATHENA.MIT.EDU \
		> test.out
	cmp test.out $(srcdir)/t_ref_kerb.out
	$(RM) test.out
	KRB5_CONFIG=$(srcdir)/t_krb5.conf ; export KRB5_CONFIG ;\
		$(RUN_SETUP) ./t_ser

check-windows::

clean::
	$(RM) t_walk_rtree$(EXEEXT) t_walk_rtree.$(OBJEXT)
	$(RM) t_kerb$(EXEEXT) t_kerb.$(OBJEXT)
	$(RM) t_ser$(EXEEXT) t_ser.$(OBJEXT)

clean-unix:: clean-libobjs
clean-windows::
	$(RM) $(OBJFILE)
