CFLAGS = $(CCOPTS) $(DEFS)

##DOSBUILDTOP = ..\..\..
##DOSMYNAME=des
##DOSOBJFILE=..\des.lst
##WIN16##LIBNAME=..\crypto.lib
PROG_LIBPATH=-L$(TOPLIBD)
PROG_RPATH=$(KRB5_LIBDIR)

RUN_SETUP = @KRB5_RUN_ENV@

STLIBOBJS=\
	afsstring2key.o \
	cbc_cksum.o	\
	finish_key.o	\
	fin_rndkey.o	\
	init_rkey.o	\
	process_ky.o	\
	random_key.o	\
	string2key.o	\
	key_sched.o	\
	weak_key.o	\
	f_cbc.o 	\
	f_cksum.o 	\
	f_sched.o 	\
	f_ecb.o 	\
	f_parity.o 	\
	f_tables.o	\
	d3_cbc.o 	\
	d3_ecb.o	\
	d3_kysched.o	\
	d3_procky.o 	\
	d3_str2ky.o	\
	u_nfold.o	\
	u_rn_key.o

OBJS=	afsstring2key.$(OBJEXT) \
	cbc_cksum.$(OBJEXT)	\
	finish_key.$(OBJEXT)	\
	fin_rndkey.$(OBJEXT)	\
	init_rkey.$(OBJEXT)	\
	process_ky.$(OBJEXT)	\
	random_key.$(OBJEXT)	\
	string2key.$(OBJEXT)	\
	key_sched.$(OBJEXT)	\
	weak_key.$(OBJEXT)	\
	f_cbc.$(OBJEXT) 	\
	f_cksum.$(OBJEXT) 	\
	f_sched.$(OBJEXT) 	\
	f_ecb.$(OBJEXT) 	\
	f_parity.$(OBJEXT) 	\
	f_tables.$(OBJEXT)	\
	d3_cbc.$(OBJEXT) 	\
	d3_ecb.$(OBJEXT)	\
	d3_kysched.$(OBJEXT)	\
	d3_procky.$(OBJEXT) 	\
	d3_str2ky.$(OBJEXT)	\
	u_nfold.$(OBJEXT)	\
	u_rn_key.$(OBJEXT)

SRCS=	$(srcdir)/afsstring2key.c \
	$(srcdir)/cbc_cksum.c	\
	$(srcdir)/finish_key.c	\
	$(srcdir)/fin_rndkey.c	\
	$(srcdir)/init_rkey.c	\
	$(srcdir)/process_ky.c	\
	$(srcdir)/random_key.c	\
	$(srcdir)/string2key.c	\
	$(srcdir)/key_sched.c	\
	$(srcdir)/weak_key.c	\
	$(srcdir)/f_cbc.c \
	$(srcdir)/f_cksum.c \
	$(srcdir)/f_sched.c \
	$(srcdir)/f_ecb.c \
	$(srcdir)/f_parity.c \
	$(srcdir)/f_tables.c \
	$(srcdir)/d3_cbc.c \
	$(srcdir)/d3_ecb.c \
	$(srcdir)/d3_kysched.c \
	$(srcdir)/d3_procky.c \
	$(srcdir)/d3_str2ky.c \
	$(srcdir)/u_nfold.c \
	$(srcdir)/u_rn_key.c

all-windows:: $(OBJFILE)

##DOS$(OBJFILE): $(OBJS)
##DOS	$(RM) $(OBJFILE)
##WIN16##	$(CP) nul: $(OBJFILE)
##WIN32##	$(LIBECHO) -p $(MYNAME)\ *.obj > $(OBJFILE)

all-unix:: all-libobjs

includes:: depend

depend:: $(SRCS)

# FIXME, this is left from the previous DES implementation.
clean::
	$(RM) fp.c ip.c key_perm.h odd.h p.c p_table.h s_table.h

verify$(EXEEXT): t_verify.$(OBJEXT) $(KRB5_BASE_DEPLIBS)
	$(CC_LINK) -o $@ t_verify.$(OBJEXT) process_ky.o  key_sched.o \
	../cryptoconf.o ../des_crc.o $(KRB5_BASE_LIBS)

destest$(EXEEXT): destest.$(OBJEXT) $(KRB5_BASE_DEPLIBS)
	$(CC_LINK) -o $@ destest.$(OBJEXT) process_ky.o key_sched.o \
	../cryptoconf.o ../des_crc.o $(KRB5_BASE_LIBS)

t_random$(EXEEXT): t_random.$(OBJEXT) $(KRB5_BASE_DEPLIBS)
	$(CC_LINK) -o $@ t_random.$(OBJEXT) $(KRB5_BASE_LIBS)

check-unix:: destest verify
	$(RUN_SETUP) ./verify -z
	$(RUN_SETUP) ./verify -m
	$(RUN_SETUP) ./verify
	$(RUN_SETUP) ./destest < $(srcdir)/keytest.data

check-windows::

clean:: 
	$(RM) destest$(EXEEXT) verify$(EXEEXT) destest.$(OBJEXT) \
	t_verify.$(OBJEXT) t_random.$(OBJEXT) t_random$(EXEEXT)

clean-windows::
	$(RM) $(OBJFILE)

clean-unix:: clean-libobjs
