snapshot-root = //GSS-Kerberos5-1.1

include-paths = {autogenerated-include-paths} -i /mac/TestTrack/ -i "/mac/libraries/CCache API/include/" -i "/mac/libraries/Kerberos v5 Globals"

################################################################################
##
## Creating build directories
##
################################################################################

create-directories :
	If Not "`Exists -d /bin`"
		NewFolder /bin
	End
	If Not "`Exists -d /bin/PPC`"
		NewFolder /bin/PPC
	End
	If Not "`Exists -d /bin/CFM-68K`"
		NewFolder /bin/CFM-68K
	End
	
################################################################################
##
## Autogenerating classic 68K glue files
##
################################################################################

classic-glue-output = /K5.CFMglue.c /GSS.CFMglue.c
classic-glue-input = /mac/K5.CFMglue.cin /mac/K5.CFMglue.proto.h /mac/CFMglue.c /mac/K5.moreCFMglue.cin \
	/mac/GSS.CFMglue.cin /mac/GSS.CFMglue.proto.h /mac/GSS.moreCFMglue.cin /mac/CFMGlue.pl

glue : {classic-glue-output}
glue-clean :
	Delete -i {classic-glue-output}

/K5.CFMglue.c : /mac/K5.CFMglue.cin /mac/K5.CFMglue.proto.h /mac/CFMglue.c /mac/K5.moreCFMglue.cin
	perl /mac/CFMGlue.pl < /mac/K5.CFMglue.proto.h > /K5.CFMglue.c
	Catenate /mac/K5.CFMglue.cin /mac/CFMglue.c /K5.CFMglue.c /mac/K5.moreCFMglue.cin | Catenate > /K5.CFMglue.c

/GSS.CFMglue.c : /mac/GSS.CFMglue.cin /mac/GSS.CFMglue.proto.h /mac/CFMglue.c /mac/GSS.moreCFMglue.cin
	perl /mac/CFMGlue.pl < /mac/GSS.CFMglue.proto.h > /GSS.CFMglue.c
	Catenate /mac/GSS.CFMglue.cin /mac/CFMglue.c /GSS.CFMglue.c /mac/GSS.moreCFMglue.cin | Catenate > /GSS.CFMglue.c

################################################################################
##
## Autogenerating header and source files
##
################################################################################

autogeneration-h-script = /util/et/et_h.perl
autogeneration-c-script = /util/et/et_c.perl

autogenerated-files = 	/include/asn1_err.h /include/kdb5_err.h /include/krb5_err.h \
	/include/kv5m_err.h /include/adm_err.h \
	/lib/gssapi/generic/gssapi_err_generic.h \
	/lib/gssapi/krb5/gssapi_err_krb5.h /util/profile/prof_err.c \
	/lib/krb5/error_tables/asn1_err.c /lib/krb5/error_tables/kdb5_err.c \
	/lib/krb5/error_tables/krb5_err.c /lib/krb5/error_tables/kv5m_err.c \
	/lib/krb5/error_tables/adm_err.c /lib/gssapi/generic/gssapi_err_generic.c \
	/lib/gssapi/krb5/gssapi_err_krb5.c /util/profile/prof_err.h \
	/include/krb5.h /util/profile/profile.h \
	/include/profile.h /include/krb5/osconf.h /lib/gssapi/generic/gssapi.h \
	/include/autoconf.h

autogeneration-sources = 	/lib/krb5/error_tables/asn1_err.et \
	/lib/krb5/error_tables/kdb5_err.et \
	/lib/krb5/error_tables/krb5_err.et \
	/lib/krb5/error_tables/kv5m_err.et \
	/lib/krb5/error_tables/adm_err.et \
	/lib/gssapi/generic/gssapi_err_generic.et \
	/lib/gssapi/krb5/gssapi_err_krb5.et \
	/util/profile/prof_err.et \
	/include/krb5.hin /util/profile/profile.hin \
	/include/krb5/stock/osconf.h /lib/gssapi/generic/gssapi.hin \
	/mac/libraries/autoconf.h

autogenerate-files : {autogenerated-files}
autogenerate-clean  :
	for output_file in {autogenerated-files}
		if "`Exists {output_file}`"
			SetFile -a l {output_file}
			Delete {output_file}
		end
	end

################################################################################
#
# com_err header files
#
################################################################################

/include/asn1_err.h : /lib/krb5/error_tables/asn1_err.et
	perl {autogeneration-h-script} outfile="/include/asn1_err.h" < "/lib/krb5/error_tables/asn1_err.et"

/include/kdb5_err.h : /lib/krb5/error_tables/kdb5_err.et
	perl {autogeneration-h-script} outfile="/include/kdb5_err.h" < "/lib/krb5/error_tables/kdb5_err.et"

/include/krb5_err.h : /lib/krb5/error_tables/krb5_err.et
	perl {autogeneration-h-script} outfile="/include/krb5_err.h" < "/lib/krb5/error_tables/krb5_err.et"

/include/kv5m_err.h : /lib/krb5/error_tables/kv5m_err.et
	perl {autogeneration-h-script} outfile="/include/kv5m_err.h" < "/lib/krb5/error_tables/kv5m_err.et"

/include/adm_err.h : /lib/krb5/error_tables/adm_err.et
	perl {autogeneration-h-script} outfile="/include/adm_err.h" < "/lib/krb5/error_tables/adm_err.et"
	
/lib/gssapi/generic/gssapi_err_generic.h : /lib/gssapi/generic/gssapi_err_generic.et
	perl {autogeneration-h-script} outfile="/lib/gssapi/generic/gssapi_err_generic.h" < "/lib/gssapi/generic/gssapi_err_generic.et"
	
/lib/gssapi/krb5/gssapi_err_krb5.h : /lib/gssapi/krb5/gssapi_err_krb5.et
	perl {autogeneration-h-script} outfile="/lib/gssapi/krb5/gssapi_err_krb5.h" < "/lib/gssapi/krb5/gssapi_err_krb5.et"

/util/profile/prof_err.h : /util/profile/prof_err.et
	perl {autogeneration-h-script} outfile="/util/profile/prof_err.h" < "/util/profile/prof_err.et"

################################################################################
#
# com_err source files
#
################################################################################

/lib/krb5/error_tables/asn1_err.c : /lib/krb5/error_tables/asn1_err.et
	perl {autogeneration-c-script} outfile="/lib/krb5/error_tables/asn1_err.c" < "/lib/krb5/error_tables/asn1_err.et"

/lib/krb5/error_tables/kdb5_err.c : /lib/krb5/error_tables/kdb5_err.et
	perl {autogeneration-c-script} outfile="/lib/krb5/error_tables/kdb5_err.c" < "/lib/krb5/error_tables/kdb5_err.et"

/lib/krb5/error_tables/krb5_err.c : /lib/krb5/error_tables/krb5_err.et
	perl {autogeneration-c-script} outfile="/lib/krb5/error_tables/krb5_err.c" < "/lib/krb5/error_tables/krb5_err.et"

/lib/krb5/error_tables/kv5m_err.c : /lib/krb5/error_tables/kv5m_err.et
	perl {autogeneration-c-script} outfile="/lib/krb5/error_tables/kv5m_err.c" < "/lib/krb5/error_tables/kv5m_err.et"

/lib/krb5/error_tables/adm_err.c : /lib/krb5/error_tables/adm_err.et
	perl {autogeneration-c-script} outfile="/lib/krb5/error_tables/adm_err.c" < "/lib/krb5/error_tables/adm_err.et"

/lib/gssapi/generic/gssapi_err_generic.c : /lib/gssapi/generic/gssapi_err_generic.et
	perl {autogeneration-c-script} outfile="/lib/gssapi/generic/gssapi_err_generic.c" < "/lib/gssapi/generic/gssapi_err_generic.et"

/lib/gssapi/krb5/gssapi_err_krb5.c : /lib/gssapi/krb5/gssapi_err_krb5.et
	perl {autogeneration-c-script} outfile="/lib/gssapi/krb5/gssapi_err_krb5.c" < "/lib/gssapi/krb5/gssapi_err_krb5.et"

/util/profile/prof_err.c : /util/profile/prof_err.et
	perl {autogeneration-c-script} outfile="/util/profile/prof_err.c" < "/util/profile/prof_err.et"

################################################################################
#
# other files
#
################################################################################

/include/krb5.h : /include/krb5.hin /include/krb5_err.h /include/kdb5_err.h /include/kv5m_err.h /include/asn1_err.h
	Catenate /include/krb5.hin /include/krb5_err.h /include/kdb5_err.h /include/kv5m_err.h /include/asn1_err.h > /include/krb5.h
	
/util/profile/profile.h : /util/profile/profile.hin /util/profile/prof_err.h
	Catenate /util/profile/profile.hin /util/profile/prof_err.h > /util/profile/profile.h
	
/include/profile.h : /util/profile/profile.h
	Duplicate -y /util/profile/profile.h /include/profile.h

/include/krb5/osconf.h : /include/krb5/stock/osconf.h
	Duplicate -y /include/krb5/stock/osconf.h /include/krb5/osconf.h

/lib/gssapi/generic/gssapi.h : /lib/gssapi/generic/gssapi.hin
	Duplicate -y /lib/gssapi/generic/gssapi.hin /lib/gssapi/generic/gssapi.h
	
/include/autoconf.h : /mac/libraries/autoconf.h
	Duplicate -y /mac/libraries/autoconf.h /include/autoconf.h

################################################################################
##
## Shared library initialization and termination sources
##
################################################################################

#
# GSS library
#

cfm-gss-src			= /mac/GSS.CFM.c
cfm-gss-obj-cfm68k	= /bin/CFM-68K/GSS.CFM.c.CFM68.o
cfm-gss-obj-ppc		= /bin/PPC/GSS.CFM.c.PPC.o

#
# Krb5 library
#

cfm-krb5-src		= /mac/K5.CFM.c
cfm-krb5-obj-cfm68k	= /bin/CFM-68K/K5.CFM.c.CFM68.o
cfm-krb5-obj-ppc	= /bin/PPC/K5.CFM.c.PPC.o

#
# TestTrack
#

testtrack-src			= /mac/TestTrack/ShlibTestTrack.c
testtrack-obj-cfm68k	= /bin/CFM-68K/ShlibTestTrack.c.CFM68.o
testtrack-obj-ppc		= /bin/PPC/ShlibTestTrack.c.PPC.o

################################################################################
##
## Precompiled header files
##
################################################################################

kerberos-headers-root		= /mac/libraries/
kerberos-headers-cfm68k		= {kerberos-headers-root}KerberosHeadersCFM-68K
kerberos-headers-ppc		= {kerberos-headers-root}KerberosHeadersPPC

################################################################################
##
## System and runtime libraries
##
################################################################################

standard-libraries-cfm68k = \
	"/bin/MIT CLib.68K" \
	"/bin/MIT RuntimeLib.68K" \
	"{MW68KLibraries}MSL ShLibRuntimeCFM68K.Lib" \
	"{SharedLibraries}InterfaceLib" \
	"{MW68KLibraries}MathLibCFM68K (4i_8d).Lib"

standard-libraries-ppc = \
	"/bin/MIT CLib.PPC" \
	"/bin/MIT RuntimeLib.PPC" \
	"{MWPPCLibraries}MSL ShLibRuntime.Lib" \
	"{SharedLibraries}InterfaceLib" \
	"{SharedLibraries}MathLib"

standard-libraries-cfm68k-debug = \
	"/bin/MIT CLib.68K.debug" \
	"/bin/MIT RuntimeLib.68K.debug" \
	"{MW68KLibraries}MSL ShLibRuntimeCFM68K.Lib" \
	"{SharedLibraries}InterfaceLib" \
	"{MW68KLibraries}MathLibCFM68K (4i_8d).Lib"

standard-libraries-ppc-debug = \
	"/bin/MIT CLib.PPC.debug" \
	"/bin/MIT RuntimeLib.PPC.debug" \
	"{MWPPCLibraries}MSL ShLibRuntime.Lib" \
	"{SharedLibraries}InterfaceLib" \
	"{SharedLibraries}MathLib"

libraries-gss-ppc = {standard-libraries-ppc}
libraries-gss-cfm68k = {standard-libraries-cfm68k}
libraries-gss-cfm68k-debug = {standard-libraries-cfm68k-debug}
libraries-gss-ppc-debug = {standard-libraries-ppc-debug}

libraries-krb5-ppc = {standard-libraries-ppc}
libraries-krb5-cfm68k = {standard-libraries-cfm68k}
libraries-krb5-ppc-debug = {standard-libraries-ppc-debug}
libraries-krb5-cfm68k-debug = {standard-libraries-cfm68k-debug}

################################################################################
##
## Common compiler and linker options
##
################################################################################

compiler-options = \
		{include-paths} -enum int -opt all -strings pool -mapcr \
        -mpw_pointers -warnings off -fatext -nosyspath -maxerrors 1000 \
        -align mac68k -opt off -toc_data on -fp_contract on -sym on \
		-model farData
		
linker-options-gss = \

linker-options-krb5 = \

################################################################################
##
## Credentials cache API libraries
##
################################################################################

ccache-cfm68K = \
	"/mac/libraries/CCache API/bin/CCacheLib.68K"
#	"/mac/libraries/CCache API/bin/CCacheGlobalsLib.68K"

ccache-ppc = \
	"/mac/libraries/CCache API/bin/CCacheLib.PPC"
#	"/mac/libraries/CCache API/bin/CCacheGlobalsLib.PPC"

ccache-cfm68K-debug = \
	"/mac/libraries/CCache API/bin/CCacheLib.68K.debug"
#	"/mac/libraries/CCache API/bin/CCacheGlobalsLib.68K"

ccache-ppc-debug = \
	"/mac/libraries/CCache API/bin/CCacheLib.PPC.debug"
#	"/mac/libraries/CCache API/bin/CCacheGlobalsLib.PPC"
	
################################################################################
##
## General rules
##
################################################################################

all : link-all glue
compile : compile-ppc compile-cfm68k compile-cfm-gss \
	compile-cfm-krb5 compile-testtrack

################################################################################
##
## Compilation rules
##
################################################################################

compile-cfm68k : {autogenerated-files} {gss-obj-cfm68k} {krb5-obj-cfm68k}
/bin/CFM-68K/ : {source-folders}
.c.CFM68.o : .c {autogenerated-files} {kerberos-headers-cfm68k}
	MWC68K {compiler-options} -o {TargDir}{Default}.c.CFM68.o -prefix {kerberos-headers-cfm68k} \
		-model cfmflat {DepDir}{Default}.c

compile-ppc : {autogenerated-files} {gss-obj-ppc} {krb5-obj-ppc}
/bin/PPC/ : {source-folders}
.c.PPC.o : .c {autogenerated-files} {kerberos-headers-ppc}
	MWCPPC {compiler-options} -o {TargDir}{Default}.c.PPC.o -prefix {kerberos-headers-ppc} {DepDir}{Default}.c

################################################################################
##
## Kerberos v5 globals library (code and data)
##
################################################################################

krb5-globals : Kerberos5GlobalsLib.PPC Kerberos5GlobalsLib.PPC.debug

#

krb5-globals-ppc = \
	Kerberos5GlobalsLib.PPC
	
krb5-globals-ppc-debug = \
	Kerberos5GlobalsLib.PPC.debug

krb5-globals-src = \
	"/mac/libraries/Kerberos v5 Globals/Krb5Globals.c"

krb5-globals-obj-ppc = \
	"/bin/PPC/Krb5Globals.c.PPC.o" \
	"/bin/PPC/Krb5Globals.CFM.c.PPC.o"

krb5-globals-data-obj-ppc = \
	"/bin/PPC/Krb5GlobalsData.c.PPC.o"
	
krb5-globals-data-ppc = \
	Kerberos5GlobalsDataLib.PPC

krb5-globals-files = \
	"/mac/libraries/Kerberos v5 Globals/Krb5Globals.c" \
	"/mac/libraries/Kerberos v5 Globals/Krb5Globals.CFM.c" \
	"/mac/libraries/Kerberos v5 Globals/Krb5Globals.CFM.h" \
	"/mac/libraries/Kerberos v5 Globals/Krb5Globals.exp" \
	"/mac/libraries/Kerberos v5 Globals/Krb5Globals.h" \
	"/mac/libraries/Kerberos v5 Globals/Krb5GlobalsData.c" \
	"/mac/libraries/Kerberos v5 Globals/Krb5GlobalsData.exp" \
	"/mac/libraries/Kerberos v5 Globals/Krb5GlobalsData.h"

#
#	compilation rules
#

/bin/PPC/Krb5Globals.c.PPC.o : "/mac/libraries/Kerberos v5 Globals/Krb5Globals.c"
	MWCPPC {compiler-options} -o /bin/PPC/Krb5Globals.c.PPC.o "/mac/libraries/Kerberos v5 Globals/Krb5Globals.c"
/bin/PPC/Krb5Globals.CFM.c.PPC.o : "/mac/libraries/Kerberos v5 Globals/Krb5Globals.CFM.c"
	MWCPPC {compiler-options} -o /bin/PPC/Krb5Globals.CFM.c.PPC.o "/mac/libraries/Kerberos v5 Globals/Krb5Globals.CFM.c"

/bin/PPC/Krb5GlobalsData.c.PPC.o : "/mac/libraries/Kerberos v5 Globals/Krb5GlobalsData.c"
	MWCPPC {compiler-options} -o /bin/PPC/Krb5GlobalsData.c.PPC.o "/mac/libraries/Kerberos v5 Globals/Krb5GlobalsData.c"

#
#	shared PPC v5 globals code library
#
	
Kerberos5GlobalsLib.PPC Krb5GlobalsLib.PPC.MAP :: "/mac/libraries/Kerberos v5 Globals/Krb5Globals.exp" {krb5-globals-obj-ppc} {krb5-globals-data-ppc}
	MWLinkPPC -sharedlibrary -name "MIT_*Krb5GlobalsLib" -m "" \
		-@export "/mac/libraries/Kerberos v5 Globals/Krb5Globals.exp" -sym on \
		-init "__initialize_Kerberos5GlobalsLib" \
		-term "__terminate_Kerberos5GlobalsLib" \
		-map Krb5GlobalsLib.PPC.MAP -o Kerberos5GlobalsLib.PPC \
		{krb5-globals-obj-ppc} {standard-libraries-ppc} {ccache-ppc} {krb5-globals-data-ppc}

Kerberos5GlobalsLib.PPC.debug Krb5GlobalsLib.PPC.debug.MAP :: "/mac/libraries/Kerberos v5 Globals/Krb5Globals.exp" {krb5-globals-obj-ppc} {krb5-globals-data-ppc}
	MWLinkPPC -sharedlibrary -name "MIT_*Krb5GlobalsLib.debug" -m "" \
		-@export "/mac/libraries/Kerberos v5 Globals/Krb5Globals.exp" -sym on \
		-init "__initialize_Kerberos5GlobalsLib" \
		-term "__terminate_Kerberos5GlobalsLib" \
		-map Krb5GlobalsLib.PPC.debug.MAP -o Kerberos5GlobalsLib.PPC.debug \
		{krb5-globals-obj-ppc} {standard-libraries-ppc-debug} {ccache-ppc-debug} {krb5-globals-data-ppc}

#
#	shared PPC v5 globals data library
#
	
Kerberos5GlobalsDataLib.PPC Krb5GlobalDataLib.PPC.MAP :: "/mac/libraries/Kerberos v5 Globals/Krb5GlobalsData.exp" {krb5-globals-data-obj-ppc}
	MWLinkPPC -sharedlibrary -name "MIT_*Krb5GlobalsDataLib" -m "" \
		-@export "/mac/libraries/Kerberos v5 Globals/Krb5GlobalsData.exp" -sym on \
		-init "__initialize" \
		-term "__terminate" \
		-sharedata \
		-map Krb5GlobalsDataLib.PPC.MAP -o Kerberos5GlobalsDataLib.PPC \
		{krb5-globals-data-obj-ppc} {ccache-ppc} \
		"{MWPPCLibraries}MSL RuntimePPC.Lib"

################################################################################
##
## Shared library initialization routines and TestTrack
##
################################################################################

compile-cfm-gss : {cfm-gss-obj-cfm68k} {cfm-gss-obj-ppc}
{cfm-gss-obj-cfm68k} : {autogenerated-files} {cfm-gss-src} {kerberos-headers-cfm68k}
	MWC68K {compiler-options} -o {cfm-gss-obj-cfm68k} -prefix {kerberos-headers-cfm68k} -model cfmflat {cfm-gss-src}
{cfm-gss-obj-ppc} : {autogenerated-files} {cfm-gss-src} {kerberos-headers-ppc}
	MWCPPC {compiler-options} -o {cfm-gss-obj-ppc} -prefix {kerberos-headers-ppc} {cfm-gss-src}

compile-cfm-krb5 : {cfm-krb5-obj-cfm68k} {cfm-krb5-obj-ppc}
{cfm-krb5-obj-cfm68k} : {autogenerated-files} {cfm-krb5-src} {kerberos-headers-cfm68k}
	MWC68K {compiler-options} -o {cfm-krb5-obj-cfm68k} -prefix {kerberos-headers-cfm68k} -model cfmflat {cfm-krb5-src}
{cfm-krb5-obj-ppc} : {autogenerated-files} {cfm-krb5-src} {kerberos-headers-ppc}
	MWCPPC {compiler-options} -o {cfm-krb5-obj-ppc} -prefix {kerberos-headers-ppc} {cfm-krb5-src}

compile-testtrack : {testtrack-obj-cfm68k} {testtrack-obj-ppc}
{testtrack-obj-cfm68k} : {autogenerated-files} {testtrack-src} {kerberos-headers-cfm68k}
	MWC68K {compiler-options} -o {testtrack-obj-cfm68k} -prefix {kerberos-headers-cfm68k} -model cfmflat {testtrack-src}
{testtrack-obj-ppc} : {autogenerated-files} {testtrack-src} {kerberos-headers-ppc}
	MWCPPC {compiler-options} -o {testtrack-obj-ppc} -prefix {kerberos-headers-ppc} {testtrack-src}

################################################################################
##
## Precompiled headers
##
################################################################################
	
{kerberos-headers-cfm68k} : {kerberos-headers-root}KerberosHeaders.pch {kerberos-headers-root}KerberosHeaders.h
	MWC68K {kerberos-headers-root}KerberosHeaders.pch -precompile {kerberos-headers-cfm68k} {compiler-options} \
		-i {kerberos-headers-root} -model cfmflat
{kerberos-headers-ppc} : {kerberos-headers-root}KerberosHeaders.pch {kerberos-headers-root}KerberosHeaders.h
	MWCPPC {kerberos-headers-root}KerberosHeaders.pch -precompile {kerberos-headers-ppc} {compiler-options} -i {kerberos-headers-root}

################################################################################
##
## Linking
##
################################################################################
# link : link-cfm68k link-ppc link-fat
# link-debug : link-cfm68k-debug link-ppc-debug link-fat-debug
link : link-ppc link-fat
link-debug : link-ppc-debug link-fat-debug
link-all : link link-debug

################################################################################
##
## CFM-68K libraries
##
################################################################################

link-cfm68k : Kerberos5Lib.68K GSSLib.68K
link-cfm68k-debug : Kerberos5Lib.68K.debug GSSLib.68K.debug
link-cmf68k-all : link-cfm68k link-cfm68k-debug

#
#	shared CFM-68K krb5 library
#
	
Kerberos5Lib.68K Kerberos5Lib.68K.MAP :: {autogenerated-files} /mac/K5Library.exp {libraries-krb5-cfm68k} {krb5-obj-cfm68k} {cfm-krb5-obj-cfm68k} {testtrack-obj-cfm68k} {ccache-cfm68k}
	MWLink68K -xm sharedlibrary -name K5Library -m "" \
		-model cfmflat -@export "/mac/K5Library.exp" -sym off \
		-map Kerberos5Lib.68K.MAP -o Kerberos5Lib.68K \
		-init "__initializeK5" -term "__terminateK5" \
		-weakimport /mac/TestTrack/MITAthenaLib -initbefore "MIT_*TestTrackLib" \
		-cv 1 -uv 1 \
		{libraries-krb5-cfm68k} {krb5-obj-cfm68k} {cfm-krb5-obj-cfm68k} {ccache-cfm68k}
Kerberos5Lib.68K :: /mac/version.r
	Rez "/mac/version.r" -a -o Kerberos5Lib.68K

Kerberos5Lib.68K.debug Kerberos5Lib.68K.debug.MAP :: {autogenerated-files} /mac/K5Library.exp {libraries-krb5-cfm68k} {krb5-obj-cfm68k} {cfm-krb5-obj-cfm68k} {testtrack-obj-cfm68k} {ccache-cfm68k-debug}
	MWLink68K -xm sharedlibrary -name "MIT_*Kerberos5Lib.debug" -m "" \
		-model cfmflat -@export "/mac/K5Library.exp" -sym off \
		-map Kerberos5Lib.68K.MAP -o Kerberos5Lib.68K.debug \
		-init "__initializeK5" -term "__terminateK5" \
		-weakimport /mac/TestTrack/MITAthenaLib -initbefore "MIT_*TestTrackLib" \
		-cv 1 -uv 1 \
		{libraries-krb5-cfm68k-debug} {krb5-obj-cfm68k} {cfm-krb5-obj-cfm68k} {ccache-cfm68k-debug}
Kerberos5Lib.68K.debug :: /mac/version.r
	Rez "/mac/version.r" -a -o Kerberos5Lib.68K.debug

#
#	shared CFM-68K GSS library
#

GSSLib.68K GSSLib.68K.MAP :: {autogenerated-files}  Kerberos5Lib.68K /mac/GSSLibrary.exp {libraries-gss-cfm68k} {gss-obj-cfm68k} {cfm-gss-obj-cfm68k}
	MWLink68K -xm sharedlibrary -name GSSLibrary -m "" \
		-model cfmflat -@export "/mac/GSSLibrary.exp" -sym off \
		-map GSSLib.68K.MAP -o GSSLib.68K \
		-init "__initializeGSS" -term "__terminateGSS" \
		-cv 1 -uv 1 \
		{libraries-gss-cfm68k} {gss-obj-cfm68k} {cfm-gss-obj-cfm68k} Kerberos5Lib.68K
GSSLib.68K :: /mac/version.r
	Rez "/mac/version.r" -a -o GSSLib.68K

GSSLib.68K.debug GSSLib.68K.debug.MAP :: {autogenerated-files}  Kerberos5Lib.68K /mac/GSSLibrary.exp {libraries-gss-cfm68k} {gss-obj-cfm68k} {cfm-gss-obj-cfm68k}
	MWLink68K -xm sharedlibrary -name "MIT_*GSSLib.debug" -m "" \
		-model cfmflat -@export "/mac/GSSLibrary.exp" -sym off \
		-map GSSLib.68K.MAP -o GSSLib.68K.debug \
		-init "__initializeGSS" -term "__terminateGSS" \
		-cv 1 -uv 1 \
		{libraries-gss-cfm68k-debug} {gss-obj-cfm68k} {cfm-gss-obj-cfm68k} Kerberos5Lib.68K
GSSLib.68K :: /mac/version.r
	Rez "/mac/version.r" -a -o GSSLib.68K.debug

################################################################################
##
## PPC libraries
##
################################################################################

link-ppc : Kerberos5Lib.PPC GSSLib.PPC
link-ppc-debug : Kerberos5Lib.PPC.debug GSSLib.PPC.debug
link-ppc-all : link-ppc link-ppc-debug

#	
#		shared PPC krb5 library
#

Kerberos5Lib.PPC Kerberos5Lib.PPC.MAP :: {autogenerated-files}  /mac/K5Library.exp {libraries-krb5-ppc} {krb5-obj-ppc} {cfm-krb5-obj-ppc} {testtrack-obj-ppc} {ccache-ppc} {krb5-globals-ppc}
	MWLinkPPC -sharedlibrary -name K5Library -m "" \
		-@export "/mac/K5Library.exp" -sym on -init "__initializeK5" \
		-term "__terminateK5" \
		-map K5LibraryPPC.MAP -o Kerberos5Lib.PPC \
		-cv 1 -uv 1 \
		{libraries-krb5-ppc} {krb5-obj-ppc} {cfm-krb5-obj-ppc} {ccache-ppc} {krb5-globals-ppc}
Kerberos5Lib.PPC :: /mac/version.r
	Rez "/mac/version.r" -a -o Kerberos5Lib.PPC

Kerberos5Lib.PPC.debug Kerberos5Lib.PPC.debug.MAP :: {autogenerated-files}  /mac/K5Library.exp {libraries-krb5-ppc} {krb5-obj-ppc} {cfm-krb5-obj-ppc} {testtrack-obj-ppc} {ccache-ppc-debug} {krb5-globals-ppc-debug}
	MWLinkPPC -sharedlibrary -name "MIT_*Kerberos5Lib.debug" -m "" \
		-@export "/mac/K5Library.exp" -sym on -init "__initializeK5" \
		-term "__terminateK5" \
		-map K5LibraryPPC.debug.MAP -o Kerberos5Lib.PPC.debug \
		-cv 1 -uv 1 \
		{libraries-krb5-ppc-debug} {krb5-obj-ppc} {cfm-krb5-obj-ppc} {ccache-ppc-debug} {krb5-globals-ppc-debug}
Kerberos5Lib.PPC.debug :: /mac/version.r
	Rez "/mac/version.r" -a -o Kerberos5Lib.PPC.debug

#
#		shared PPC GSS library
#

GSSLib.PPC GSSLib.PPC.MAP :: {autogenerated-files} Kerberos5Lib.PPC /mac/GSSLibrary.exp {libraries-gss-ppc} {gss-obj-ppc} {cfm-gss-obj-ppc}
	MWLinkPPC -sharedlibrary -name GSSLibrary -m "" \
		-@export "/mac/GSSLibrary.exp" -sym on -init "__initializeGSS" \
		-term "__terminateGSS" -map GSSLib.PPC.MAP -o GSSLib.PPC \
		-cv 1 -uv 1 \
		{libraries-gss-ppc} {gss-obj-ppc} {cfm-gss-obj-ppc} Kerberos5Lib.PPC
GSSLib.PPC :: /mac/version.r
	Rez "/mac/version.r" -a -o GSSLib.PPC

GSSLib.PPC.debug GSSLib.PPC.debug.MAP :: {autogenerated-files} Kerberos5Lib.PPC.debug /mac/GSSLibrary.exp {libraries-gss-ppc} {gss-obj-ppc} {cfm-gss-obj-ppc}
	MWLinkPPC -sharedlibrary -name "MIT_*GSSLib.debug" -m "" \
		-@export "/mac/GSSLibrary.exp" -sym on -init "__initializeGSS" \
		-term "__terminateGSS" -map GSSLib.PPC.debug.MAP -o GSSLib.PPC.debug \
		-cv 1 -uv 1 \
		{libraries-gss-ppc-debug} {gss-obj-ppc} {cfm-gss-obj-ppc} Kerberos5Lib.PPC.debug
GSSLib.PPC.debug :: /mac/version.r
	Rez "/mac/version.r" -a -o GSSLib.PPC.debug

################################################################################
##
## Fat libraries
##
################################################################################
# fixme/ not really fat, just ppc

link-fat : GSSLib
link-fat-debug : GSSLib.debug
link-fat-all :Êlink-fat link-fat-debug

GSSLib : GSSLib.PPC Kerberos5Lib.PPC {ccache-ppc} # GSSLib.68K Kerberos5Lib.68K {ccache-cfm68k}
	Delete -i GSSLib
	Duplicate -y GSSLib.PPC GSSLib
#	MergeFragment GSSLib.68K GSSLib
	MergeFragment "/bin/MIT CLib.PPC" GSSLib
	MergeFragment "/bin/MIT RuntimeLib.PPC" GSSLib
	MergeFragment Kerberos5Lib.PPC GSSLib
#	MergeFragment Kerberos5Lib.68K GSSLib
#	MergeFragment "/bin/MIT CLib.68K" GSSLib
#	MergeFragment "/bin/MIT RuntimeLib.68K" GSSLib
#	MergeFragment "/mac/libraries/CCache API/bin/CCacheLib.68K" GSSLib
#	MergeFragment "/mac/libraries/CCache API/bin/CCacheGlobalsLib.68K" GSSLib
	MergeFragment "/mac/libraries/CCache API/bin/CCacheLib.PPC" GSSLib
	MergeFragment "/mac/libraries/CCache API/bin/CCacheGlobalsLib.PPC" GSSLib
#	MergeFragment "/mac/libraries/DES/bin/deslib.68K" GSSLib
	MergeFragment "/mac/libraries/DES/bin/deslib.PPC" GSSLib
	MergeFragment "Kerberos5GlobalsLib.PPC" GSSLib
	MergeFragment "Kerberos5GlobalsDataLib.PPC" GSSLib
	DeRez -only "'cfrg'(0)" GSSLib "{RIncludes}"CodeFragments.r | StreamEdit -s /mac/FragmentAlias.mpw | Rez -a -o GSSLib -i "{RIncludes}"
	

GSSLib.debug : GSSLib.PPC.debug Kerberos5Lib.PPC.debug {ccache-ppc-debug} # GSSLib.68K.debug Kerberos5Lib.68K.debug {ccache-cfm68k-debug}
	Delete -i GSSLib.debug
	Duplicate -y GSSLib.PPC.debug GSSLib.debug
#	MergeFragment GSSLib.68K.debug GSSLib.debug
	MergeFragment "/bin/MIT CLib.PPC.debug" GSSLib.debug
	MergeFragment "/bin/MIT RuntimeLib.PPC.debug" GSSLib.debug
	MergeFragment Kerberos5Lib.PPC.debug GSSLib.debug
#	MergeFragment Kerberos5Lib.68K.debug GSSLib.debug
#	MergeFragment "/bin/MIT CLib.68K" GSSLib.debug
#	MergeFragment "/bin/MIT RuntimeLib.68K" GSSLib.debug
#	MergeFragment "/mac/libraries/CCache API/bin/CCacheLib.68K.debug" GSSLib.debug
#	MergeFragment "/mac/libraries/CCache API/bin/CCacheGlobalsLib.68K" GSSLib.debug
	MergeFragment "/mac/libraries/CCache API/bin/CCacheLib.PPC.debug" GSSLib.debug
	MergeFragment "/mac/libraries/CCache API/bin/CCacheGlobalsLib.PPC" GSSLib.debug
#	MergeFragment "/mac/libraries/DES/bin/deslib.68K.debug" GSSLib.debug
	MergeFragment "/mac/libraries/DES/bin/deslib.PPC.debug" GSSLib.debug
	MergeFragment "Kerberos5GlobalsLib.PPC.debug" GSSLib.debug
	MergeFragment "Kerberos5GlobalsDataLib.PPC" GSSLib.debug
	DeRez -only "'cfrg'(0)" GSSLib.debug "{RIncludes}"CodeFragments.r | StreamEdit -s /mac/FragmentAlias.mpw | Rez -a -o GSSLib.debug -i "{RIncludes}"
	
################################################################################
##
## Clean targets
##
################################################################################

# This target punts things that get created during an MPW build

clean : autogenerate-clean glue-clean
	Delete -i {gss-obj-cfm68k} {gss-obj-ppc} \
		{krb5-obj-cfm68k} {krb5-obj-ppc} \
		{kerberos-headers-cfm68k} {kerberos-headers-ppc} \
		{cfm-gss-obj-cfm68k} {cfm-gss-obj-ppc} \
		{cfm-krb5-obj-cfm68k} {cfm-krb5-obj-ppc} 
		{krb5-globals-obj-ppc} {krb5-globals-data-obj-ppc}

# This target also punts everything that gets created in other ways during normal
# build process (CW files etc)

dist-clean : clean
	Delete -i -y /bin \
		"/mac/libraries/Metrowerks/CW Pro 2/MIT C.CFM68K DLL.prj Data" \
		"/mac/libraries/Metrowerks/CW Pro 2/MIT C.PPC DLL.prj Data" \
		"/mac/libraries/Metrowerks/CW Pro 2/MIT RuntimeCFM68K DLL.prj Data" \
		"/mac/libraries/Metrowerks/CW Pro 2/MIT RuntimePPC DLL.prj Data"
	Delete -i GSSLib GSSLib.PPC GSSLib.68K Kerberos5Lib.PPC Kerberos5Lib.68K \
		GSSLib.68K.MAP GSSLib.68K.SYM GSSLib.PPC.MAP GSSLib.PPC.xSYM \
		Kerberos5Lib.68K.MAP Kerberos5Lib.68K.SYM Kerberos5Lib.PPC.MAP Kerberos5Lib.PPC.xSYM \
		/mac/libraries/KerberosHeaders.pch.68k.o /mac/libraries/KerberosHeaders.pch.ppc.o \
		Makefile
		
################################################################################
##
## Snapshot
##
################################################################################

mac-files = `perl "/mac/macfile_gen.pl" maclist`
mac-folders = `perl "/mac/macfile_gen.pl" macdirs`

all-mac-files = \
	{mac-files} \
	{classic-glue-input} \
	{autogeneration-sources} \
	{krb5-globals-files} \
	/Makefile.in /patchlevel.h \
	/util/et/et_h.perl /util/et/et_c.perl \
	/mac/GSS.CFM.c \
	/mac/GSS.CFMglue.h \
	/mac/GSSLibrary.exp \
	/mac/GSSLibrary.SAP.exp \
	/mac/K5.CFM.c \
	/mac/K5.CFMglue.h \
	/mac/K5Library.exp \
	/mac/krb5.ini \
	/mac/macfile_gen.pl \
	/mac/Makefile.tmpl \
	/mac/ReadMe \
	/mac/version.r \
	/mac/FragmentAlias.mpw \
	/mac/RunAppleScript.pl \
	"/mac/Release notes" \
	/mac/libraries/autoconf.h \
	/mac/libraries/ChangeLog \
	/mac/libraries/KerberosHeaders.h \
	/mac/libraries/KerberosHeaders.pch \
	/mac/libraries/KerberosHeadersCFM.pch \
	"/mac/libraries/CodeWarrior Dependencies/Pro2.prj" \
	"/mac/libraries/CodeWarrior Dependencies/Pro4.prj" \
	"/mac/libraries/Metrowerks/CW Pro 2/MIT C.CFM68K DLL.prj" \
	"/mac/libraries/Metrowerks/CW Pro 2/MIT C.PPC DLL.prj" \
	"/mac/libraries/Metrowerks/CW Pro 2/MIT RuntimeCFM68K DLL.prj" \
	"/mac/libraries/Metrowerks/CW Pro 2/MIT RuntimePPC DLL.prj" \
	"/mac/libraries/Metrowerks/CW Pro 2/MIT C.CFM68K DLL.doc" \
	"/mac/libraries/Metrowerks/CW Pro 2/MIT C.PPC DLL.doc" \
	"/mac/libraries/Metrowerks/CW Pro 2/MIT RuntimeCFM68K DLL.doc" \
	"/mac/libraries/Metrowerks/CW Pro 2/MIT RuntimePPC DLL.doc" \
	"/mac/libraries/Metrowerks/CW Pro 4/MIT C.CFM68K DLL.prj" \
	"/mac/libraries/Metrowerks/CW Pro 4/MIT C.PPC DLL.prj" \
	"/mac/libraries/Metrowerks/CW Pro 4/MIT RuntimeCFM68K DLL.prj" \
	"/mac/libraries/Metrowerks/CW Pro 4/MIT RuntimePPC DLL.prj" \
	"/mac/libraries/Metrowerks/CW Pro 4/MIT C.CFM68K DLL.doc" \
	"/mac/libraries/Metrowerks/CW Pro 4/MIT C.PPC DLL.doc" \
	"/mac/libraries/Metrowerks/CW Pro 4/MIT RuntimeCFM68K DLL.doc" \
	"/mac/libraries/Metrowerks/CW Pro 4/MIT RuntimePPC DLL.doc" \
	"/mac/libraries/CCache API/include/CCache.h" \
	"/mac/libraries/CCache API/bin/CCacheGlobalsLib.68K" \
	"/mac/libraries/CCache API/bin/CCacheGlobalsLib.PPC" \
	"/mac/libraries/CCache API/bin/CCacheLib.68K.debug" \
	"/mac/libraries/CCache API/bin/CCacheLib.PPC.debug" \
	"/mac/libraries/CCache API/bin/CCacheLib.68K" \
	"/mac/libraries/CCache API/bin/CCacheLib.PPC" \
	/mac/libraries/DES/bin/deslib.68K \
	/mac/libraries/DES/bin/deslib.68K.debug \
	/mac/libraries/DES/bin/deslib.PPC \
	/mac/libraries/DES/bin/deslib.PPC.debug \
	/mac/libraries/DES/doc/ChangeLog \
	/mac/libraries/DES/doc/f_README \
	/mac/libraries/DES/doc/READ_ME \
	/mac/libraries/DES/doc/ren.msg \
	/mac/libraries/DES/include/des.h \
	/mac/libraries/DES/include/deslib.CFMGlue.c \
	/mac/libraries/DES/include/deslib.CFMGlue.h \
	/mac/libraries/DES/include/mit-copyright.h	 \
	/mac/TestTrack/ChangeLog \
	/mac/TestTrack/GSSforSAP.r \
	/mac/TestTrack/MITAthenaLib \
	/mac/TestTrack/ShlibTestTrack.c \
	/mac/TestTrack/ShlibTestTrack.h \
	/mac/TestTrack/TestTrackLib.h \
	/mac/TestTrack/testtrack.h \
	/mac/templatify.pl
all-mac-folders = /config/ /include/ /include/krb5/ /include/krb5/stock/ \
	/include/sys/ /lib/ /lib/krb5/ /lib/gssapi/ /util/ {mac-folders} \
	/mac/ \
	/mac/kconfig/ \
	/mac/libraries/ \
	"/mac/libraries/CodeWarrior Dependencies/" \
	/mac/libraries/Metrowerks/ \
	"/mac/libraries/Metrowerks/CW Pro 2/" \
	"/mac/libraries/Metrowerks/CW Pro 4/" \
	"/mac/libraries/CCache API/" \
	"/mac/libraries/CCache API/bin" \
	"/mac/libraries/CCache API/include" \
	"/mac/libraries/Kerberos v5 Globals" \
	/mac/libraries/DES/ \
	/mac/libraries/DES/bin \
	/mac/libraries/DES/doc \
	/mac/libraries/DES/include \
	/mac/testtrack/

snapshot : autogenerate-clean
	NewFolder {snapshot-root}
	For shapshot-folder in {all-mac-folders}
		NewFolder "{snapshot-root}{shapshot-folder}"
		if "`Exists {TargDir}"{shapshot-folder}Makefile.in"`"
			Duplicate -y {TargDir}"{shapshot-folder}Makefile.in" {snapshot-root}"{shapshot-folder}Makefile.in"
			SetFile -a l {snapshot-root}"{shapshot-folder}Makefile.in"
		end
	end
	For snapshot-file in {all-mac-files}
		if "`Exists {TargDir}"{snapshot-file}"`"
			Duplicate -y {TargDir}"{snapshot-file}" {snapshot-root}"{snapshot-file}"
			SetFile -a l {snapshot-root}"{snapshot-file}"
		end
	end
	Duplicate /mac/Makefile.initial {snapshot-root}/Makefile
	SetFile -a l {snapshot-root}/Makefile

################################################################################
##
## Makefile
##
################################################################################

Makefile : /mac/Makefile.tmpl
	perl /mac/macfile_gen.pl
